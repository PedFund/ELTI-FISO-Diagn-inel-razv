"""
API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
–í–µ—Ä—Å–∏—è: Final (–ò–º—è —Ñ–∞–π–ª–∞: 5-31_results.xlsx)
"""

from flask import Flask, request, send_file, jsonify, render_template_string
import pandas as pd
import io
import re
import os

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è Vercel
import openpyxl
import xlsxwriter
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024

# --- –ú–≠–ü–ü–ò–ù–ì ---
COLUMN_MAPPING = {
    "ID": "ID",
    "–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è": "–í—Ä–µ–º—è",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
    "–ö–æ–¥ —Ä–µ–±—ë–Ω–∫–∞": "–ö–æ–¥",
    "–°–æ–≥–ª–∞—Å–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è (–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è) –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–æ-–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞ –ø–æ–ª—É—á–µ–Ω–æ": "–°–æ–≥–ª–∞—Å–∏–µ_–æ–±—Å–ª–µ–¥",
    "–°–æ–≥–ª–∞—Å–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è (–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è) –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–µ–±—ë–Ω–∫–∞ –ø–æ–ª—É—á–µ–Ω–æ": "–°–æ–≥–ª–∞—Å–∏–µ_–ü–î",
    "–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ä–µ–±–µ–Ω–æ–∫ –≤ —Ç–µ–∫—É—â–µ–º —É—á–µ–±–Ω–æ–º –≥–æ–¥—É": "–í–æ–∑—Ä–∞—Å—Ç",
    "–í–≤–µ—Å—Ç–∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω—É—é –≥—Ä—É–ø–ø—É": "–í–æ–∑—Ä–∞—Å—Ç_–≤–≤–æ–¥",
    '–°—É–±—Ç–µ—Å—Ç –ò1-1 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º–∞—Ä–Ω—É—é –æ—Ü–µ–Ω–∫—É': "–ò1-1–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –°–≤—è–∑–Ω–æ—Å—Ç—å': "–ò1-2–°–≤—è–∑–Ω",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –†–µ—á–µ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π': "–ò1-2–†–µ—á–û—Ñ–æ—Ä–º",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è': "–ò1-2–°–∞–º–†–∞—Å—Å",
    '–°—É–±—Ç–µ—Å—Ç –ò2 "–°—Ö–æ–¥—Å—Ç–≤–æ". –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º–∞—Ä–Ω—É—é –æ—Ü–µ–Ω–∫—É.': "–ò2–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò3-1-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 1-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-1–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-1-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 1-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-1–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-2-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 2-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-2–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-2-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 2-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-2–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-3-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 3-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-3–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-3-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 3-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-3–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-4-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 4-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-4–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-4-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 4-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-4–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-5-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 5-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-5–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-5-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 5-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-5–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò4 "–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–µ—Ç–∞–ª–∏". –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤': "–ò4–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 1 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-1–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 1 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-1–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 1': "–ò5-1–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 2 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-2–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 2 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-2–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 2': "–ò5-2–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 3 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-3–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 3 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-3–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 3': "–ò5-3–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 4 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-4–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 4 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-4–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 4': "–ò5-4–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 5 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-5–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 5 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-5–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 5': "–ò5-5–î–æ—à–µ–ª",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". \n–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–∞–º –í1 –∏ –í2. / –í1': "–í1",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". \n–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–∞–º –í1 –∏ –í2. / –í2': "–í2",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". –î–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–µ –í3 –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Å–∫–∞–Ω —Ä–∏—Å—É–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–º –¥–æ 1 –ú–±.': "–í3_—Ñ–æ—Ç–æ",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–∞–∑–æ–≤—ã—Ö —ç–º–æ—Ü–∏–π. / –£–∫–∞–∂–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É': "–≠–º–æ—Ü–ò–¥–µ–Ω—Ç",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ': "–ü–ª–∞–Ω–∏—Ä",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ': "–°–æ—Ç—Ä—É–¥",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –†–µ—Ñ–ª–µ–∫—Å–∏—è': "–†–µ—Ñ–ª–µ–∫",
    '–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–µ –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω–æ–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º.': "–ü—Ä–∏–º–µ—á"
}

# --- HTML ---
HTML_TEMPLATE = '''<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Kidski (Full)</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 550px; text-align: center; }
        h1 { color: #1a202c; font-size: 1.8rem; margin-bottom: 0.5rem; }
        p.subtitle { color: #718096; margin-bottom: 2rem; }
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 3rem 2rem; cursor: pointer; transition: 0.2s; background: #f7fafc; }
        .upload-area:hover { border-color: #4299e1; background: #ebf8ff; }
        .icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; font-size: 1rem; margin-top: 1.5rem; cursor: pointer; width: 100%; box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11); transition: transform 0.1s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1); }
        .btn:active { transform: translateY(1px); }
        #status { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none; text-align: left; font-size: 0.95rem; line-height: 1.5; }
        .error { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
        .success { background: #f0fff4; color: #2f855a; border: 1px solid #9ae6b4; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üìä –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û—Ç—á—ë—Ç–æ–≤</h1>
        <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel –∏–ª–∏ CSV —Ñ–∞–π–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</p>
        <form id="form">
            <div class="upload-area" id="dropZone">
                <span class="icon">üìÅ</span>
                <strong>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</strong>
                <div id="fileName" style="margin-top: 10px; color: #4a5568; font-size: 0.9rem;"></div>
                <input type="file" id="file" accept=".xlsx,.xls,.csv" hidden>
            </div>
            <button type="submit" class="btn">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –°–∫–∞—á–∞—Ç—å</button>
        </form>
        <div id="status"></div>
    </div>
    <script>
        const fileInput = document.getElementById('file');
        const dropZone = document.getElementById('dropZone');
        
        dropZone.onclick = () => fileInput.click();
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = '#4299e1'; };
        dropZone.ondragleave = (e) => { e.preventDefault(); dropZone.style.borderColor = '#cbd5e0'; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e0';
            if(e.dataTransfer.files[0]) {
                fileInput.files = e.dataTransfer.files;
                document.getElementById('fileName').textContent = fileInput.files[0].name;
            }
        };

        fileInput.onchange = () => document.getElementById('fileName').textContent = fileInput.files[0]?.name || '';

        document.getElementById('form').onsubmit = async (e) => {
            e.preventDefault();
            const status = document.getElementById('status');
            if (!fileInput.files[0]) {
                status.textContent = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!";
                status.className = "error";
                status.style.display = "block";
                return;
            }

            status.textContent = "‚è≥ –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...";
            status.className = "";
            status.style.display = "block";

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch('/api/process', { method: 'POST', body: formData });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // –ò–º—è —Ñ–∞–π–ª–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ (—Ç–∞–º —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ)
                    const contentDisposition = res.headers.get('Content-Disposition');
                    let filename = res.headers.get('X-Filename') || 'results.xlsx';
                    
                    a.download = filename;
                    a.click();
                    status.innerHTML = "‚úÖ <b>–ì–æ—Ç–æ–≤–æ!</b><br>–§–∞–π–ª <b>" + filename + "</b> —Å–∫–∞—á–∞–Ω.";
                    status.className = "success";
                } else {
                    const text = await res.text();
                    try {
                        const json = JSON.parse(text);
                        status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (json.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
                    } catch {
                        status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + text.slice(0, 150);
                    }
                    status.className = "error";
                }
            } catch (err) {
                status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
                status.className = "error";
            }
        };
    </script>
</body>
</html>'''

# --- –§–£–ù–ö–¶–ò–ò ---

def to_float(val):
    if pd.isna(val) or val == "": return 0
    if isinstance(val, (int, float)): return val
    try:
        return float(str(val).replace(',', '.').replace(' ', '').strip())
    except:
        return 0

def to_int(val):
    try: return int(to_float(val))
    except: return 0

def calc_lab(time, errors, reached, limit):
    time = to_float(time)
    errors = to_int(errors)
    if isinstance(reached, str) and reached.strip().lower() == "–Ω–µ—Ç": return 0
    if time > limit: return 0
    if errors == 0: return 3
    if errors == 1: return 2
    if 2 <= errors <= 5: return 1
    return 0

def attention_index(rings, errors):
    return 0.5 * to_float(rings) - (2.8 * to_float(errors)) / 60

def categorize(value):
    if pd.isna(value): return "–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"
    if value < 0.33: return "–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"
    elif value <= 0.66: return "–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π"
    else: return "–≤—ã—à–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"

def extract_town(org_name):
    s = str(org_name)
    match = re.search(r"\((.*?)\)", s)
    if match:
        return match.group(1).split(";")[0].strip()
    return "–ù–µ —É–∫–∞–∑–∞–Ω–æ"

def sort_key_town(name):
    if pd.isna(name): return (999, "")
    name = str(name).strip()
    if name == "–≥.–ú–æ—Å–∫–≤–∞": return (0, name)
    if name.startswith("–≥."): return (1, name)
    if name.startswith(("—Ä.–ø.", "–ø.", "–ø–æ—Å.")): return (2, name)
    return (6, name)

# --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
def process_excel(file_content, filename):
    # –ü–∞—Ä—Å–∏–º –∏–º—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    match = re.match(r'(\d+)-(\d+)', filename)
    ploshchadka = match.group(1) if match else "XX"
    diagnostika = match.group(2) if match else "YY"

    # 1. –ó–∞–≥—Ä—É–∑–∫–∞
    file_io = io.BytesIO(file_content)
    try:
        df = pd.read_excel(file_io, sheet_name=0)
    except:
        file_io.seek(0)
        try:
            df = pd.read_csv(file_io, sep=None, engine='python')
        except Exception as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç. {e}")

    df.columns = df.columns.str.strip()
    df = df.rename(columns=COLUMN_MAPPING)

    # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
    for col in COLUMN_MAPPING.values():
        if col not in df.columns: df[col] = 0

    # –û—á–∏—Å—Ç–∫–∞ —á–∏—Å–µ–ª
    numeric_cols = [
        "–ò5-1–í—Ä–µ–º—è", "–ò5-1–û—à–∏–±", "–ò5-2–í—Ä–µ–º—è", "–ò5-2–û—à–∏–±", "–ò5-3–í—Ä–µ–º—è", "–ò5-3–û—à–∏–±",
        "–ò5-4–í—Ä–µ–º—è", "–ò5-4–û—à–∏–±", "–ò5-5–í—Ä–µ–º—è", "–ò5-5–û—à–∏–±", "–ò3-1–ö–æ–ª—å—Ü–∞", "–ò3-1–û—à–∏–±",
        "–ò3-2–ö–æ–ª—å—Ü–∞", "–ò3-2–û—à–∏–±", "–ò3-3–ö–æ–ª—å—Ü–∞", "–ò3-3–û—à–∏–±", "–ò3-4–ö–æ–ª—å—Ü–∞", "–ò3-4–û—à–∏–±",
        "–ò3-5–ö–æ–ª—å—Ü–∞", "–ò3-5–û—à–∏–±", "–ò1-1–°—É–º", "–ò2–°—É–º", "–ò4–°—É–º", "–ò1-2–°–≤—è–∑–Ω",
        "–ò1-2–†–µ—á–û—Ñ–æ—Ä–º", "–ò1-2–°–∞–º–†–∞—Å—Å", "–í1", "–í2", "–≠–º–æ—Ü–ò–¥–µ–Ω—Ç", "–ü–ª–∞–Ω–∏—Ä", "–°–æ—Ç—Ä—É–¥", "–†–µ—Ñ–ª–µ–∫"
    ]
    for col in numeric_cols:
        if col in df.columns:
            df[col] = df[col].apply(to_float)

    # 2. –†–∞—Å—á–µ—Ç—ã
    df["–ü1"] = df.apply(lambda x: calc_lab(x.get("–ò5-1–í—Ä–µ–º—è"), x.get("–ò5-1–û—à–∏–±"), x.get("–ò5-1–î–æ—à–µ–ª"), 35), axis=1)
    df["–ü2"] = df.apply(lambda x: calc_lab(x.get("–ò5-2–í—Ä–µ–º—è"), x.get("–ò5-2–û—à–∏–±"), x.get("–ò5-2–î–æ—à–µ–ª"), 35), axis=1)
    df["–ü3"] = df.apply(lambda x: calc_lab(x.get("–ò5-3–í—Ä–µ–º—è"), x.get("–ò5-3–û—à–∏–±"), x.get("–ò5-3–î–æ—à–µ–ª"), 50), axis=1)
    df["–ü4"] = df.apply(lambda x: calc_lab(x.get("–ò5-4–í—Ä–µ–º—è"), x.get("–ò5-4–û—à–∏–±"), x.get("–ò5-4–î–æ—à–µ–ª"), 65), axis=1)
    df["–ü5"] = df.apply(lambda x: calc_lab(x.get("–ò5-5–í—Ä–µ–º—è"), x.get("–ò5-5–û—à–∏–±"), x.get("–ò5-5–î–æ—à–µ–ª"), 125), axis=1)
    df["–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç"] = ((df[["–ü1", "–ü2", "–ü3", "–ü4", "–ü5"]].mean(axis=1)) / 3).round(2)

    for i in range(1, 6):
        df[f"–í–Ω–∏–º{i}"] = df.apply(lambda x: attention_index(x.get(f"–ò3-{i}–ö–æ–ª—å—Ü–∞"), x.get(f"–ò3-{i}–û—à–∏–±")), axis=1)
    
    df["–°—Ä–µ–¥–í–Ω–∏–º"] = df[[f"–í–Ω–∏–º{i}" for i in range(1, 6)]].mean(axis=1)
    df["–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è"] = df["–°—Ä–µ–¥–í–Ω–∏–º"].apply(lambda v: 1 if v >= 6 else round(v / 6, 2))

    df["–°–≤—è–∑–Ω"] = (df["–ò1-2–°–≤—è–∑–Ω"] / 5).round(2)
    df["–†–µ—á–û—Ñ–æ—Ä–º"] = (df["–ò1-2–†–µ—á–û—Ñ–æ—Ä–º"] / 5).round(2)
    df["–°–∞–º–æ—Å—Ç–†–∞—Å—Å"] = (df["–ò1-2–°–∞–º–†–∞—Å—Å"] / 5).round(2)

    df["–ì–æ—Ç–æ–≤–Ω_–£–î"] = ((df["–ò1-1–°—É–º"] / 18 + (df["–°–≤—è–∑–Ω"] + df["–†–µ—á–û—Ñ–æ—Ä–º"] + df["–°–∞–º–æ—Å—Ç–†–∞—Å—Å"]) / 3) / 2).round(2)
    df["–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ"] = (df["–ò2–°—É–º"] / 16).round(2)
    df["–ü–µ—Ä—Ü–µ–ø—Ü–∏—è"] = (df["–ò4–°—É–º"] / 11).round(2)
    df["–ê–∫—Ç–∏–≤–Ω_–≤–Ω–∏–º–∞–Ω"] = df["–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è"]
    df["–ê–Ω–∞–ª–∏—Ç_—Å–∏–Ω—Ç"] = df["–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç"]
    df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ"] = (((df["–í1"] / 3) + (df["–í2"] / 3)) / 2).round(2)
    df["–ò–¥–µ–Ω—Ç–∏—Ñ_—ç–º–æ—Ü–∏–π"] = (df["–≠–º–æ—Ü–ò–¥–µ–Ω—Ç"] / 8).round(2)
    df["–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"] = (df["–ü–ª–∞–Ω–∏—Ä"] / 4).round(2)
    df["–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"] = (df["–°–æ—Ç—Ä—É–¥"] / 4).round(2)
    df["–†–µ—Ñ–ª–µ–∫—Å–∏—è"] = (df["–†–µ—Ñ–ª–µ–∫"] / 4).round(2)

    df["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ"] = ((df["–ì–æ—Ç–æ–≤–Ω_–£–î"] + df["–ê–∫—Ç–∏–≤–Ω_–≤–Ω–∏–º–∞–Ω"] + df["–ê–Ω–∞–ª–∏—Ç_—Å–∏–Ω—Ç"] + df["–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ"] + df["–ü–µ—Ä—Ü–µ–ø—Ü–∏—è"]) / 5).round(2)
    df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥"] = df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ"]
    df["–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"] = ((df["–ò–¥–µ–Ω—Ç–∏—Ñ_—ç–º–æ—Ü–∏–π"] + (df["–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"] + df["–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"] + df["–†–µ—Ñ–ª–µ–∫—Å–∏—è"]) / 3) / 2).round(2)

    for col in ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]:
        df[col + "_—É—Ä–æ–≤–µ–Ω—å"] = df[col].apply(categorize)

    # 3. Excel
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        wb = writer.book
        fmt_header = wb.add_format({"bold": True, "bg_color": "#D9E1F2", "align": "center", "valign": "vcenter", "border": 1})
        fmt_num = wb.add_format({"num_format": "0.00", "align": "center"})
        fmt_pct = wb.add_format({"num_format": "0.0%", "align": "center"})
        
        # –õ–∏—Å—Ç 1: –í–æ–∑—Ä–∞—Å—Ç—ã
        age_counts = df["–í–æ–∑—Ä–∞—Å—Ç"].value_counts().reset_index()
        age_counts.columns = ["–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π"]
        if not age_counts.empty:
            age_counts.to_excel(writer, sheet_name="–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", index=False)
            ws = writer.sheets["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã"]
            ch = wb.add_chart({"type": "pie"})
            ch.add_series({
                "name": "–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã",
                "categories": ["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", 1, 0, len(age_counts), 0],
                "values": ["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", 1, 1, len(age_counts), 1],
            })
            ws.insert_chart("E2", ch)
        
        # –õ–∏—Å—Ç 2: –ú–µ–¥–∏–∞–Ω—ã (–° –õ–ï–ü–ï–°–¢–ö–û–í–û–ô –î–ò–ê–ì–†–ê–ú–ú–û–ô)
        cols_med = ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–ì–æ—Ç–æ–≤–Ω_–£–î", "–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ", "–ü–µ—Ä—Ü–µ–ø—Ü–∏—è", 
                    "–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è", "–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]
        med_df = df[cols_med].apply(pd.to_numeric, errors='coerce').median().reset_index()
        med_df.columns = ["–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", "–ú–µ–¥–∏–∞–Ω–∞"]
        
        if not med_df.empty:
            med_df.to_excel(writer, sheet_name="–ú–µ–¥–∏–∞–Ω—ã", index=False)
            ws = writer.sheets["–ú–µ–¥–∏–∞–Ω—ã"]
            ws.set_column(0, 0, 25)
            ch_med = wb.add_chart({'type': 'radar', 'subtype': 'filled'})
            ch_med.add_series({
                'name': '–ú–µ–¥–∏–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è',
                'categories': ['–ú–µ–¥–∏–∞–Ω—ã', 1, 0, len(med_df), 0],
                'values':     ['–ú–µ–¥–∏–∞–Ω—ã', 1, 1, len(med_df), 1],
                'line':       {'color': 'blue'},
                'fill':       {'color': 'blue', 'transparency': 80}
            })
            ch_med.set_title({'name': '–ü—Ä–æ—Ñ–∏–ª—å –≥—Ä—É–ø–ø—ã (–ú–µ–¥–∏–∞–Ω—ã)'})
            ch_med.set_style(10)
            ws.insert_chart('D2', ch_med, {'x_scale': 1.5, 'y_scale': 1.5})

        # –õ–∏—Å—Ç—ã —É—Ä–æ–≤–Ω–µ–π
        for metr in ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]:
            sh_name = metr.replace(" ", "_")[:30]
            if df.empty:
                t = pd.DataFrame(columns=["–£—Ä–æ–≤–µ–Ω—å", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–î–æ–ª—è"])
            else:
                t = df[metr + "_—É—Ä–æ–≤–µ–Ω—å"].value_counts().reindex(
                    ["–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ", "–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π", "–≤—ã—à–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"], fill_value=0
                ).reset_index()
                t.columns = ["–£—Ä–æ–≤–µ–Ω—å", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
                t["–î–æ–ª—è"] = t["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"] / len(df)
            
            t.to_excel(writer, sheet_name=sh_name, index=False)
            ws = writer.sheets[sh_name]
            for c, name in enumerate(t.columns):
                ws.write(0, c, name, fmt_header)
            ws.set_column(2, 2, 12, fmt_pct)
            ws.set_column(0, 0, 20)
            if not t.empty:
                ch = wb.add_chart({'type': 'column'})
                ch.add_series({
                    'name': metr,
                    'categories': [sh_name, 1, 0, 3, 0],
                    'values':     [sh_name, 1, 1, 3, 1],
                    'data_labels': {'value': True}
                })
                ch.set_title({'name': f'–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: {metr}'})
                ws.insert_chart('E2', ch)

        # –õ–∏—Å—Ç 6: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        df["–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç"] = df["–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"].apply(extract_town)
        towns = df.groupby("–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç")["–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"].nunique().reset_index()
        towns.columns = ["–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π"]
        towns = towns.sort_values(by="–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç", key=lambda col: col.map(sort_key_town))
        total_orgs = towns["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π"].sum()
        towns_with_total = pd.concat([towns, pd.DataFrame({
            "–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç": ["–ò–¢–û–ì–û"], 
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π": [total_orgs]
        })], ignore_index=True)
        towns_with_total.to_excel(writer, sheet_name="–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã", index=False)
        ws_towns = writer.sheets["–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã"]
        ws_towns.set_column(0, 0, 30)
        ws_towns.set_row(len(towns_with_total), None, wb.add_format({'bold': True}))

        # –õ–∏—Å—Ç 7: –ò—Ç–æ–≥–æ
        df_export = df[["–ö–æ–¥", "–í–æ–∑—Ä–∞—Å—Ç", "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ_—É—Ä–æ–≤–µ–Ω—å",
                        "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥_—É—Ä–æ–≤–µ–Ω—å", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç_—É—Ä–æ–≤–µ–Ω—å"]]
        df_export.to_excel(writer, sheet_name="–ò—Ç–æ–≥–æ–≤—ã–π_–û—Ç—á–µ—Ç", index=False)
        ws = writer.sheets["–ò—Ç–æ–≥–æ–≤—ã–π_–û—Ç—á–µ—Ç"]
        for c, name in enumerate(df_export.columns):
            ws.write(0, c, name, fmt_header)
            ws.set_column(c, c, 18)

    output.seek(0)
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: "5-31_results.xlsx"
    output_filename = f"{ploshchadka}-{diagnostika}_results.xlsx"
    
    return output.getvalue(), output_filename

# --- FLASK ---
@app.route('/')
def index(): return render_template_string(HTML_TEMPLATE)

@app.route('/api/process', methods=['POST'])
def process():
    try:
        if 'file' not in request.files: return jsonify({'error': '–ù–µ—Ç —Ñ–∞–π–ª–∞'}), 400
        f = request.files['file']
        if not f.filename: return jsonify({'error': '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'}), 400
        
        data, name = process_excel(f.read(), f.filename)
        response = send_file(io.BytesIO(data), mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', as_attachment=True, download_name=name)
        
        # –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, —á—Ç–æ–±—ã JS –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –µ–≥–æ —É–≤–∏–¥–µ–ª
        response.headers['X-Filename'] = name
        # –¢–∞–∫–∂–µ –ø–æ–ª–µ–∑–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Access-Control-Expose-Headers, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã —Å CORS
        response.headers['Access-Control-Expose-Headers'] = 'X-Filename'
        
        return response
    except Exception as e:
        return jsonify({'error': str(e)}), 500

app = app
