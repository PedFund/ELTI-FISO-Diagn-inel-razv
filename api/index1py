"""
API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
Fixes: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CSV, –∑–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç—ã—Ö –≤ —á–∏—Å–ª–∞—Ö, –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
"""

from flask import Flask, request, send_file, jsonify, render_template_string
import pandas as pd
import io
import re
import os

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è Vercel (—á—Ç–æ–±—ã –≤–∫–ª—é—á–∏–ª–∏—Å—å –≤ —Å–±–æ—Ä–∫—É)
import openpyxl
import xlsxwriter
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB

# --- –ú–≠–ü–ü–ò–ù–ì –ö–û–õ–û–ù–û–ö ---
COLUMN_MAPPING = {
    "ID": "ID",
    "–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è": "–í—Ä–µ–º—è",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
    "–ö–æ–¥ —Ä–µ–±—ë–Ω–∫–∞": "–ö–æ–¥",
    "–°–æ–≥–ª–∞—Å–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è (–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è) –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–æ-–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞ –ø–æ–ª—É—á–µ–Ω–æ": "–°–æ–≥–ª–∞—Å–∏–µ_–æ–±—Å–ª–µ–¥",
    "–°–æ–≥–ª–∞—Å–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è (–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è) –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–µ–±—ë–Ω–∫–∞ –ø–æ–ª—É—á–µ–Ω–æ": "–°–æ–≥–ª–∞—Å–∏–µ_–ü–î",
    "–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ä–µ–±–µ–Ω–æ–∫ –≤ —Ç–µ–∫—É—â–µ–º —É—á–µ–±–Ω–æ–º –≥–æ–¥—É": "–í–æ–∑—Ä–∞—Å—Ç",
    "–í–≤–µ—Å—Ç–∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω—É—é –≥—Ä—É–ø–ø—É": "–í–æ–∑—Ä–∞—Å—Ç_–≤–≤–æ–¥",
    '–°—É–±—Ç–µ—Å—Ç –ò1-1 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º–∞—Ä–Ω—É—é –æ—Ü–µ–Ω–∫—É': "–ò1-1–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –°–≤—è–∑–Ω–æ—Å—Ç—å': "–ò1-2–°–≤—è–∑–Ω",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –†–µ—á–µ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π': "–ò1-2–†–µ—á–û—Ñ–æ—Ä–º",
    '–°—É–±—Ç–µ—Å—Ç –ò1-2 "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è". –£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é / –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è': "–ò1-2–°–∞–º–†–∞—Å—Å",
    '–°—É–±—Ç–µ—Å—Ç –ò2 "–°—Ö–æ–¥—Å—Ç–≤–æ". –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º–∞—Ä–Ω—É—é –æ—Ü–µ–Ω–∫—É.': "–ò2–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò3-1-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 1-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-1–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-1-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 1-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-1–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-2-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 2-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-2–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-2-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 2-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-2–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-3-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 3-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-3–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-3-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 3-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-3–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-4-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 4-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-4–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-4-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 4-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-4–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò3-5-1 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞ 5-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-5–ö–æ–ª—å—Ü–∞",
    '–°—É–±—Ç–µ—Å—Ç –ò3-5-2 "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω". –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞ 5-—é –º–∏–Ω—É—Ç—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò3-5–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò4 "–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–µ—Ç–∞–ª–∏". –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤': "–ò4–°—É–º",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 1 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-1–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 1 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-1–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-1-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 1': "–ò5-1–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 2 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-2–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 2 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-2–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-2-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 2': "–ò5-2–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 3 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-3–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 3 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-3–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-3-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 3': "–ò5-3–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 4 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-4–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 4 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-4–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-4-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 4': "–ò5-4–î–æ—à–µ–ª",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-1 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 5 (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)': "–ò5-5–í—Ä–µ–º—è",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-2 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã": —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ 5 (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)': "–ò5-5–û—à–∏–±",
    '–°—É–±—Ç–µ—Å—Ç –ò5-5-3 "–õ–∞–±–∏—Ä–∏–Ω—Ç—ã". –û—Ç–º–µ—Ç—å—Ç–µ, –¥–æ—à–µ–ª –ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –¥–æ —Ü–µ–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –í–∞–º–∏ –≤—Ä–µ–º—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ 5': "–ò5-5–î–æ—à–µ–ª",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". \n–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–∞–º –í1 –∏ –í2. / –í1': "–í1",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". \n–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–∞–º –í1 –∏ –í2. / –í2': "–í2",
    '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–∞ "–•—É–¥–æ–∂–Ω–∏–∫". –î–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —à–∫–∞–ª–µ –í3 –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Å–∫–∞–Ω —Ä–∏—Å—É–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–º –¥–æ 1 –ú–±.': "–í3_—Ñ–æ—Ç–æ",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–∞–∑–æ–≤—ã—Ö —ç–º–æ—Ü–∏–π. / –£–∫–∞–∂–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É': "–≠–º–æ—Ü–ò–¥–µ–Ω—Ç",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ': "–ü–ª–∞–Ω–∏—Ä",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ': "–°–æ—Ç—Ä—É–¥",
    '–ú–µ—Ç–æ–¥–∏–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / –†–µ—Ñ–ª–µ–∫—Å–∏—è': "–†–µ—Ñ–ª–µ–∫",
    '–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∏–∂–µ –í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω–æ–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º.': "–ü—Ä–∏–º–µ—á"
}

# --- HTML –®–ê–ë–õ–û–ù ---
HTML_TEMPLATE = '''<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Kidski</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f6f8; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 1.5rem; }
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 2rem; cursor: pointer; transition: 0.2s; background: #fafbfc; }
        .upload-area:hover { border-color: #4299e1; background: #ebf8ff; }
        .btn { background: #4299e1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; margin-top: 1rem; cursor: pointer; width: 100%; }
        .btn:hover { background: #3182ce; }
        #status { margin-top: 1rem; padding: 1rem; border-radius: 6px; display: none; text-align: left; font-size: 0.9rem; word-break: break-word; }
        .error { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
        .success { background: #f0fff4; color: #2f855a; border: 1px solid #9ae6b4; }
        .info { color: #718096; font-size: 0.85rem; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h1>
        <form id="form">
            <div class="upload-area" id="dropZone">
                <p>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <p class="info">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: .xlsx, .xls, .csv</p>
                <input type="file" id="file" accept=".xlsx,.xls,.csv" hidden>
            </div>
            <div id="fileName" style="margin-top: 10px; font-weight: bold; color: #4a5568;"></div>
            <button type="submit" class="btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
        </form>
        <div id="status"></div>
    </div>
    <script>
        const fileInput = document.getElementById('file');
        const dropZone = document.getElementById('dropZone');
        
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = () => document.getElementById('fileName').textContent = fileInput.files[0]?.name || '';

        document.getElementById('form').onsubmit = async (e) => {
            e.preventDefault();
            const status = document.getElementById('status');
            if (!fileInput.files[0]) {
                status.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!";
                status.className = "error";
                status.style.display = "block";
                return;
            }

            status.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞... –ñ–¥–∏—Ç–µ...";
            status.className = "";
            status.style.display = "block";

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch('/api/process', { method: 'POST', body: formData });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = res.headers.get('X-Filename') || 'result.xlsx';
                    a.click();
                    status.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —Å–∫–∞—á–∞–Ω.";
                    status.className = "success";
                } else {
                    const text = await res.text();
                    try {
                        const json = JSON.parse(text);
                        status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (json.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
                    } catch {
                        status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + text.slice(0, 100);
                    }
                    status.className = "error";
                }
            } catch (err) {
                status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message;
                status.className = "error";
            }
        };
    </script>
</body>
</html>'''

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def to_float(val):
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –∑–∞–ø—è—Ç–æ–π –≤ —á–∏—Å–ª–æ (Russian locale friendly)"""
    if pd.isna(val) or val == "":
        return 0
    if isinstance(val, (int, float)):
        return val
    try:
        # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
        clean_val = str(val).replace(',', '.').replace(' ', '').strip()
        return float(clean_val)
    except:
        return 0

def to_int(val):
    try:
        return int(to_float(val))
    except:
        return 0

def calc_lab(time, errors, reached, limit):
    time = to_float(time)
    errors = to_int(errors)
    
    if isinstance(reached, str) and reached.strip().lower() == "–Ω–µ—Ç":
        return 0
    if time > limit:
        return 0
    if errors == 0:
        return 3
    if errors == 1:
        return 2
    if 2 <= errors <= 5:
        return 1
    return 0

def attention_index(rings, errors):
    rings = to_float(rings)
    errors = to_float(errors)
    return 0.5 * rings - (2.8 * errors) / 60

def categorize(value):
    if pd.isna(value): return "–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"
    if value < 0.33: return "–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"
    elif value <= 0.66: return "–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π"
    else: return "–≤—ã—à–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"

def extract_town(org_name):
    match = re.search(r"\((.*?)\)", str(org_name))
    if match:
        return match.group(1).split(";")[0].strip()
    return "–ù–µ —É–∫–∞–∑–∞–Ω–æ"

def sort_key_town(name):
    if pd.isna(name): return (999, "")
    name = str(name).strip()
    if name == "–≥.–ú–æ—Å–∫–≤–∞": return (0, name)
    elif name.startswith("–≥."): return (1, name)
    elif name.startswith(("—Ä.–ø.", "–ø.", "–ø–æ—Å.")): return (2, name)
    elif name.startswith("—Å."): return (3, name)
    elif name.startswith("–¥."): return (4, name)
    elif name.startswith("—Å—Ç."): return (5, name)
    return (6, name)

# --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

def process_excel(file_content, filename):
    # –ü–∞—Ä—Å–∏–Ω–≥ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    match = re.match(r'(\d+)-(\d+)', filename)
    if match:
        ploshchadka = match.group(1)
        diagnostika = match.group(2)
    else:
        ploshchadka = "XX"
        diagnostika = "YY"

    # 1. –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª (Excel –∏–ª–∏ CSV)
    file_io = io.BytesIO(file_content)
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è —á–∏—Ç–∞—Ç—å –∫–∞–∫ Excel
        df = pd.read_excel(file_io, sheet_name=0)
    except:
        try:
            # –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ, –ø—ã—Ç–∞–µ–º—Å—è –∫–∞–∫ CSV (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∑–∞–ø—è—Ç–∞—è –∏–ª–∏ —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π)
            file_io.seek(0)
            df = pd.read_csv(file_io, sep=None, engine='python')
        except Exception as e:
            raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ Excel (.xlsx) –∏–ª–∏ CSV. –û—à–∏–±–∫–∞: {e}")

    # 2. –û—á–∏—Å—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–æ–ª–æ–Ω–æ–∫)
    df.columns = df.columns.str.strip()

    # 3. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (Mapping)
    df = df.rename(columns=COLUMN_MAPPING)

    # 4. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ (–ó–∞—â–∏—Ç–∞ –æ—Ç KeyError)
    for col in COLUMN_MAPPING.values():
        if col not in df.columns:
            df[col] = 0  # –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç, –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω—É–ª—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ

    # 5. –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ (String "15,5" -> Float 15.5)
    numeric_columns = [
        "–ò5-1–í—Ä–µ–º—è", "–ò5-1–û—à–∏–±", "–ò5-2–í—Ä–µ–º—è", "–ò5-2–û—à–∏–±", 
        "–ò5-3–í—Ä–µ–º—è", "–ò5-3–û—à–∏–±", "–ò5-4–í—Ä–µ–º—è", "–ò5-4–û—à–∏–±", "–ò5-5–í—Ä–µ–º—è", "–ò5-5–û—à–∏–±",
        "–ò3-1–ö–æ–ª—å—Ü–∞", "–ò3-1–û—à–∏–±", "–ò3-2–ö–æ–ª—å—Ü–∞", "–ò3-2–û—à–∏–±",
        "–ò3-3–ö–æ–ª—å—Ü–∞", "–ò3-3–û—à–∏–±", "–ò3-4–ö–æ–ª—å—Ü–∞", "–ò3-4–û—à–∏–±", "–ò3-5–ö–æ–ª—å—Ü–∞", "–ò3-5–û—à–∏–±",
        "–ò1-1–°—É–º", "–ò2–°—É–º", "–ò4–°—É–º", 
        "–ò1-2–°–≤—è–∑–Ω", "–ò1-2–†–µ—á–û—Ñ–æ—Ä–º", "–ò1-2–°–∞–º–†–∞—Å—Å",
        "–í1", "–í2", "–≠–º–æ—Ü–ò–¥–µ–Ω—Ç", "–ü–ª–∞–Ω–∏—Ä", "–°–æ—Ç—Ä—É–¥", "–†–µ—Ñ–ª–µ–∫"
    ]
    
    for col in numeric_columns:
        if col in df.columns:
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —É–º–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é (–∑–∞–ø—è—Ç—ã–µ -> —Ç–æ—á–∫–∏)
            df[col] = df[col].apply(to_float)

    # 6. –†–∞—Å—á–µ—Ç—ã
    df["–ü1"] = df.apply(lambda x: calc_lab(x.get("–ò5-1–í—Ä–µ–º—è"), x.get("–ò5-1–û—à–∏–±"), x.get("–ò5-1–î–æ—à–µ–ª"), 35), axis=1)
    df["–ü2"] = df.apply(lambda x: calc_lab(x.get("–ò5-2–í—Ä–µ–º—è"), x.get("–ò5-2–û—à–∏–±"), x.get("–ò5-2–î–æ—à–µ–ª"), 35), axis=1)
    df["–ü3"] = df.apply(lambda x: calc_lab(x.get("–ò5-3–í—Ä–µ–º—è"), x.get("–ò5-3–û—à–∏–±"), x.get("–ò5-3–î–æ—à–µ–ª"), 50), axis=1)
    df["–ü4"] = df.apply(lambda x: calc_lab(x.get("–ò5-4–í—Ä–µ–º—è"), x.get("–ò5-4–û—à–∏–±"), x.get("–ò5-4–î–æ—à–µ–ª"), 65), axis=1)
    df["–ü5"] = df.apply(lambda x: calc_lab(x.get("–ò5-5–í—Ä–µ–º—è"), x.get("–ò5-5–û—à–∏–±"), x.get("–ò5-5–î–æ—à–µ–ª"), 125), axis=1)
    df["–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç"] = ((df[["–ü1", "–ü2", "–ü3", "–ü4", "–ü5"]].mean(axis=1)) / 3).round(2)

    for i in range(1, 6):
        df[f"–í–Ω–∏–º{i}"] = df.apply(lambda x: attention_index(x.get(f"–ò3-{i}–ö–æ–ª—å—Ü–∞"), x.get(f"–ò3-{i}–û—à–∏–±")), axis=1)
    
    df["–°—Ä–µ–¥–í–Ω–∏–º"] = df[[f"–í–Ω–∏–º{i}" for i in range(1, 6)]].mean(axis=1)
    df["–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è"] = df["–°—Ä–µ–¥–í–Ω–∏–º"].apply(lambda v: 1 if v >= 6 else round(v / 6, 2))

    df["–°–≤—è–∑–Ω"] = (df["–ò1-2–°–≤—è–∑–Ω"] / 5).round(2)
    df["–†–µ—á–û—Ñ–æ—Ä–º"] = (df["–ò1-2–†–µ—á–û—Ñ–æ—Ä–º"] / 5).round(2)
    df["–°–∞–º–æ—Å—Ç–†–∞—Å—Å"] = (df["–ò1-2–°–∞–º–†–∞—Å—Å"] / 5).round(2)

    df["–ì–æ—Ç–æ–≤–Ω_–£–î"] = ((df["–ò1-1–°—É–º"] / 18 + (df["–°–≤—è–∑–Ω"] + df["–†–µ—á–û—Ñ–æ—Ä–º"] + df["–°–∞–º–æ—Å—Ç–†–∞—Å—Å"]) / 3) / 2).round(2)
    df["–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ"] = (df["–ò2–°—É–º"] / 16).round(2)
    df["–ü–µ—Ä—Ü–µ–ø—Ü–∏—è"] = (df["–ò4–°—É–º"] / 11).round(2)
    df["–ê–∫—Ç–∏–≤–Ω_–≤–Ω–∏–º–∞–Ω"] = df["–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è"]
    df["–ê–Ω–∞–ª–∏—Ç_—Å–∏–Ω—Ç"] = df["–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç"]
    df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ"] = (((df["–í1"] / 3) + (df["–í2"] / 3)) / 2).round(2)
    df["–ò–¥–µ–Ω—Ç–∏—Ñ_—ç–º–æ—Ü–∏–π"] = (df["–≠–º–æ—Ü–ò–¥–µ–Ω—Ç"] / 8).round(2)
    df["–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"] = (df["–ü–ª–∞–Ω–∏—Ä"] / 4).round(2)
    df["–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"] = (df["–°–æ—Ç—Ä—É–¥"] / 4).round(2)
    df["–†–µ—Ñ–ª–µ–∫—Å–∏—è"] = (df["–†–µ—Ñ–ª–µ–∫"] / 4).round(2)

    df["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ"] = ((df["–ì–æ—Ç–æ–≤–Ω_–£–î"] + df["–ê–∫—Ç–∏–≤–Ω_–≤–Ω–∏–º–∞–Ω"] + df["–ê–Ω–∞–ª–∏—Ç_—Å–∏–Ω—Ç"] + 
                                   df["–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ"] + df["–ü–µ—Ä—Ü–µ–ø—Ü–∏—è"]) / 5).round(2)
    df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥"] = df["–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ"]
    df["–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"] = ((df["–ò–¥–µ–Ω—Ç–∏—Ñ_—ç–º–æ—Ü–∏–π"] + 
                             (df["–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"] + df["–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"] + df["–†–µ—Ñ–ª–µ–∫—Å–∏—è"]) / 3) / 2).round(2)

    for col in ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]:
        df[col + "_—É—Ä–æ–≤–µ–Ω—å"] = df[col].apply(categorize)

    # 7. –°–±–æ—Ä–∫–∞ Excel —Ñ–∞–π–ª–∞
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        wb = writer.book
        
        # –°—Ç–∏–ª–∏
        fmt_header = wb.add_format({"bold": True, "bg_color": "#D9E1F2", "align": "center", "valign": "vcenter", "border": 1})
        fmt_num = wb.add_format({"num_format": "0.00", "align": "center"})
        fmt_pct = wb.add_format({"num_format": "0.0%", "align": "center"})
        
        # –õ–∏—Å—Ç 1: –í–æ–∑—Ä–∞—Å—Ç—ã
        age_counts = df["–í–æ–∑—Ä–∞—Å—Ç"].value_counts().reset_index()
        age_counts.columns = ["–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π"]
        if not age_counts.empty:
            age_counts.to_excel(writer, sheet_name="–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", index=False)
            ws = writer.sheets["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã"]
            ch = wb.add_chart({"type": "pie"})
            ch.add_series({
                "name": "–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã",
                "categories": ["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", 1, 0, len(age_counts), 0],
                "values": ["–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã", 1, 1, len(age_counts), 1],
            })
            ws.insert_chart("E2", ch)
        
        # –õ–∏—Å—Ç 2: –ú–µ–¥–∏–∞–Ω—ã
        cols_med = ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–ì–æ—Ç–æ–≤–Ω_–£–î", "–õ–æ–≥_–æ–±–æ–±—â–µ–Ω–∏–µ", "–ü–µ—Ä—Ü–µ–ø—Ü–∏—è", 
                    "–ö–∞—á–µ—Å—Ç–≤–æ –≤–Ω–∏–º–∞–Ω–∏—è", "–ê–Ω–∞–ª–∏—Ç-–°–∏–Ω—Ç", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]
        # –°—á–∏—Ç–∞–µ–º –º–µ–¥–∏–∞–Ω—É —Ç–æ–ª—å–∫–æ –ø–æ —á–∏—Å–ª–æ–≤—ã–º
        med_df = df[cols_med].apply(pd.to_numeric, errors='coerce').median().reset_index()
        med_df.columns = ["–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", "–ú–µ–¥–∏–∞–Ω–∞"]
        med_df.to_excel(writer, sheet_name="–ú–µ–¥–∏–∞–Ω—ã", index=False)
        
        # –õ–∏—Å—Ç—ã —É—Ä–æ–≤–Ω–µ–π
        for metr in ["–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç"]:
            sh_name = metr.replace(" ", "_")[:30]
            if df.empty:
                t = pd.DataFrame(columns=["–£—Ä–æ–≤–µ–Ω—å", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"])
            else:
                t = df[metr + "_—É—Ä–æ–≤–µ–Ω—å"].value_counts().reindex(
                    ["–Ω–∏–∂–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ", "–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π", "–≤—ã—à–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ"], fill_value=0
                ).reset_index()
                t.columns = ["–£—Ä–æ–≤–µ–Ω—å", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
                t["–î–æ–ª—è"] = t["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"] / len(df)
            
            t.to_excel(writer, sheet_name=sh_name, index=False)
            ws = writer.sheets[sh_name]
            for c, name in enumerate(t.columns):
                ws.write(0, c, name, fmt_header)
            ws.set_column(2, 2, 10, fmt_pct)

        # –õ–∏—Å—Ç –ò—Ç–æ–≥–æ
        df_export = df[["–ö–æ–¥", "–í–æ–∑—Ä–∞—Å—Ç", "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ", "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ_—É—Ä–æ–≤–µ–Ω—å",
                        "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ_–∏—Ç–æ–≥_—É—Ä–æ–≤–µ–Ω—å", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–≠–º–°–æ—Ü–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç_—É—Ä–æ–≤–µ–Ω—å"]]
        df_export.to_excel(writer, sheet_name="–ò—Ç–æ–≥–æ–≤—ã–π_–û—Ç—á–µ—Ç", index=False)
        ws = writer.sheets["–ò—Ç–æ–≥–æ–≤—ã–π_–û—Ç—á–µ—Ç"]
        for c, name in enumerate(df_export.columns):
            ws.write(0, c, name, fmt_header)
            ws.set_column(c, c, 15)

    output.seek(0)
    return output.getvalue(), f"Result_{ploshchadka}-{diagnostika}.xlsx"

# --- FLASK ROUTES ---

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/process', methods=['POST'])
def process():
    try:
        if 'file' not in request.files:
            return jsonify({'error': '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 400
        file = request.files['file']
        if file.filename == '':
            return jsonify({'error': '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'}), 400
        
        file_content = file.read()
        result_content, result_name = process_excel(file_content, file.filename)
        
        return send_file(
            io.BytesIO(result_content),
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            as_attachment=True,
            download_name=result_name
        )
    except Exception as e:
        return jsonify({'error': str(e)}), 500

app = app
